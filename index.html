<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåü Sistema de Evidencias - ONG</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4CAF50; /* Verde brillante para la acci√≥n */
            --secondary-color: #8BC34A; /* Verde m√°s suave */
            --accent-color: #FFC107; /* Amarillo para destacar */
            --background-light: #e8f5e9; /* Fondo suave verde claro */
            --background-dark: #f0f4c3; /* Alternativa para secciones */
            --text-dark: #333;
            --text-light: #555;
            --card-bg: #fff;
            --border-color: #c8e6c9;
            --shadow-light: rgba(0, 0, 0, 0.1);
            --shadow-medium: rgba(0, 0, 0, 0.15);
            --success-color: #2e7d32; /* Verde oscuro para √©xito */
            --error-color: #d32f2f; /* Rojo oscuro para error */
            --info-color: #1976d2; /* Azul para informaci√≥n */
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--background-light);
            color: var(--text-dark);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 900px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            animation: fadeIn 1s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .header {
            text-align: center;
            padding: 20px;
            background: var(--primary-color);
            color: white;
            border-radius: 12px;
            box-shadow: 0 4px 8px var(--shadow-medium);
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
        }

        .header p {
            font-size: 1rem;
            opacity: 0.9;
        }
        
        .main-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 8px var(--shadow-light);
            border: 1px solid var(--border-color);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px var(--shadow-medium);
        }

        .card h2 {
            font-family: 'Open Sans', sans-serif;
            font-size: 1.5rem;
            color: var(--primary-color);
            margin-bottom: 15px;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 8px;
            text-align: center;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--text-dark);
        }
        
        .form-group select, .form-group input, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 1rem;
            font-family: 'Open Sans', sans-serif;
        }

        .btn {
            display: inline-block;
            padding: 12px 25px;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #43A047;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-secondary:hover {
            background-color: #7CB342;
            transform: translateY(-2px);
        }

        .btn-warning {
            background-color: var(--accent-color);
            color: var(--text-dark);
        }

        .btn-warning:hover {
            background-color: #FFB300;
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background-color: #ef5350;
            color: white;
        }

        .btn-danger:hover {
            background-color: #e53935;
            transform: translateY(-2px);
        }

        .btn-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .camera-container {
            position: relative;
            width: 100%;
            height: 300px;
            background-color: #333;
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px auto;
        }
        
        #camera-stream {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }

        #photo-canvas {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: none;
        }
        
        .placeholder-text {
            color: white;
            font-size: 1.2rem;
            text-align: center;
        }

        .hidden {
            display: none;
        }

        .message {
            padding: 10px;
            border-radius: 6px;
            margin-top: 15px;
            font-weight: 600;
            text-align: center;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        .message.show {
            opacity: 1;
        }

        .message.success {
            background-color: #e8f5e9;
            color: var(--success-color);
        }
        
        .message.error {
            background-color: #ffebee;
            color: var(--error-color);
        }
        
        .message.info {
            background-color: #e3f2fd;
            color: var(--info-color);
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            .header h1 {
                font-size: 2rem;
            }
            .card {
                padding: 15px;
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h1>Sistema de Evidencias</h1>
            <p>Captura y guarda evidencias fotogr√°ficas de tus gestiones.</p>
        </div>

        <div class="card">
            <h2>Capturar Evidencia</h2>
            <div id="evidence-form">
                <div class="form-group">
                    <label for="evidenceType">Tipo de Evidencia:</label>
                    <select id="evidenceType" required>
                        <option value="">-- Selecciona el tipo principal --</option>
                        <option value="Seguimiento a participantes">Seguimiento a participantes</option>
                        <option value="Operativas de gesti√≥n">Operativas de gesti√≥n</option>
                        <option value="Visitas Domiciliarias">Visitas Domiciliarias</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="specificType">Tipo Espec√≠fico:</label>
                    <select id="specificType" required>
                        <option value="">-- Primero selecciona el tipo principal --</option>
                    </select>
                </div>

                <div id="participants-section" class="form-group hidden">
                    <label for="participantCode">Participante:</label>
                    <select id="participantCode">
                        <option value="">-- Selecciona un participante --</option>
                    </select>
                </div>

                <div id="tutor-section" class="form-group hidden">
                    <label for="tutor-name">Tutor:</label>
                    <select id="tutor-name">
                        <option value="">-- Selecciona un tutor --</option>
                    </select>
                </div>

                <div id="description-section" class="form-group hidden">
                    <label for="additional-info">Descripci√≥n Adicional (Opcional):</label>
                    <textarea id="additional-info" rows="3" placeholder="A√±ade detalles relevantes..."></textarea>
                </div>
            </div>

            <div class="camera-container">
                <video id="camera-stream" playsinline></video>
                <canvas id="photo-canvas"></canvas>
                <span id="placeholder-text" class="placeholder-text">Click en "Iniciar C√°mara" para comenzar</span>
            </div>

            <div class="btn-container">
                <button id="start-camera-button" class="btn btn-primary">Iniciar C√°mara</button>
                <button id="stop-camera-button" class="btn btn-danger hidden">Detener C√°mara</button>
            </div>

            <div class="btn-container">
                <button id="capture-button" class="btn btn-primary hidden">Capturar Foto</button>
            </div>

            <div id="save-section" class="btn-container hidden">
                <button id="save-button" class="btn btn-success">Guardar Evidencia</button>
                <button id="reset-button" class="btn btn-warning">Tomar Otra Foto</button>
            </div>

            <div id="message" class="message"></div>
        </div>

        <div class="card">
            <h2>Descargar Evidencias</h2>
            <div id="download-form">
                <div class="form-group">
                    <label for="download-main-type">Tipo de Evidencia:</label>
                    <select id="download-main-type">
                        <option value="">-- Selecciona el tipo principal --</option>
                        <option value="Seguimiento a participantes">Seguimiento a participantes</option>
                        <option value="Operativas de gesti√≥n">Operativas de gesti√≥n</option>
                        <option value="Visitas Domiciliarias">Visitas Domiciliarias</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="download-specific-type">Tipo Espec√≠fico:</label>
                    <select id="download-specific-type">
                        <option value="">-- Primero selecciona el tipo principal --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="download-month">Mes y A√±o:</label>
                    <input type="month" id="download-month" required>
                </div>
                <div class="btn-container">
                    <button id="download-button" class="btn btn-secondary">Descargar Evidencias</button>
                </div>
            </div>
            <div id="download-message" class="message"></div>
        </div>

    </div>

    <script>
        // URL de tu Apps Script
        const scriptURL = 'https://script.google.com/macros/s/AKfycbz7pEks_KhWPnNwBU7lyWVvgk4u9VEfJeFN4Z4dkoPn-fF2cAHvBhS7FM3l8XN0L9RycA/exec';

        // Elementos del DOM
        const cameraStreamElement = document.getElementById('camera-stream');
        const captureButton = document.getElementById('capture-button');
        const canvas = document.getElementById('photo-canvas');
        const saveButton = document.getElementById('save-button');
        const startCameraButton = document.getElementById('start-camera-button');
        const stopCameraButton = document.getElementById('stop-camera-button');
        const saveSection = document.getElementById('save-section');
        const evidenceForm = document.getElementById('evidence-form');

        const evidenceTypeSelect = document.getElementById('evidenceType');
        const specificTypeSelect = document.getElementById('specificType');
        const participantsSection = document.getElementById('participants-section');
        const participantCodeSelect = document.getElementById('participantCode');
        const descriptionSection = document.getElementById('description-section');
        const descriptionInput = document.getElementById('additional-info');
        const tutorSection = document.getElementById('tutor-section');
        const tutorNameSelect = document.getElementById('tutor-name');
        const messageElement = document.getElementById('message');
        
        // Descarga
        const downloadForm = document.getElementById('download-form');
        const downloadMainTypeSelect = document.getElementById('download-main-type');
        const downloadSpecificTypeSelect = document.getElementById('download-specific-type');
        const downloadMonthInput = document.getElementById('download-month');
        const downloadButton = document.getElementById('download-button');
        const downloadMessageElement = document.getElementById('download-message');
        const resetButton = document.getElementById('reset-button');
        const placeholderText = document.getElementById('placeholder-text');

        // Variables de estado
        let mediaStream = null;
        let photoTaken = false;

        // Diccionario para opciones de tipos de evidencia
        const EVIDENCE_OPTIONS = {
            'Seguimiento a participantes': [
                'Asistencia', 'Seguimiento Psicosocial', 'Registro Nutricional', 'Llamada de Verificaci√≥n'
            ],
            'Operativas de gesti√≥n': [
                'Donaci√≥n de Equipos', 'Reuni√≥n de Equipo', 'Reuni√≥n con Aliados', 'Capacitaciones'
            ],
            'Visitas Domiciliarias': [
                'Visita de Bienvenida', 'Visita de Seguimiento', 'Visita de Entrega de Apoyo'
            ]
        };

        // Diccionario de participantes (ejemplo)
        const PARTICIPANTS_OPTIONS = [
            { name: "Andr√©s Guti√©rrez", code: "P001" },
            { name: "Sof√≠a Vargas", code: "P002" },
            { name: "Juan David Ram√≠rez", code: "P003" },
            { name: "Camila S√°nchez", code: "P004" },
            { name: "Valeria Herrera", code: "P005" }
        ];

        // Diccionario de tutores
        const TUTOR_OPTIONS = [
            "Jhonatan Osorio", "Karen Jaramillo", "Carolina G√≥mez", "Luis Cardona"
        ];

        // Eventos del formulario de captura
        evidenceTypeSelect.addEventListener('change', () => {
            updateSpecificTypes();
            toggleSections();
            resetPhoto();
        });

        specificTypeSelect.addEventListener('change', () => {
            toggleSections();
            resetPhoto();
        });
        
        resetButton.addEventListener('click', () => {
            resetPhoto();
            startCameraButton.classList.remove('hidden');
        });

        // Eventos del formulario de descarga
        downloadMainTypeSelect.addEventListener('change', () => {
            updateDownloadSpecificTypes();
            downloadMessageElement.textContent = '';
            downloadMessageElement.className = 'message';
        });

        // Funciones de la c√°mara
        startCameraButton.addEventListener('click', () => {
            startCamera();
        });

        stopCameraButton.addEventListener('click', () => {
            stopCamera();
        });

        captureButton.addEventListener('click', () => {
            capturePhoto();
        });

        saveButton.addEventListener('click', async () => {
            const evidenceType = evidenceTypeSelect.value;
            const specificType = specificTypeSelect.value;
            const participantCode = participantCodeSelect.value;
            const additionalInfo = descriptionInput.value || '';
            const tutorName = tutorNameSelect.value;

            if (!evidenceType || !specificType) {
                showMessage('Selecciona un tipo de evidencia y uno espec√≠fico para continuar.', 'error', messageElement);
                return;
            }

            if (evidenceType === 'Seguimiento a participantes' && !participantCode) {
                showMessage('Por favor, selecciona un participante.', 'error', messageElement);
                return;
            }

            if (evidenceType === 'Operativas de gesti√≥n' && !tutorName) {
                showMessage('Por favor, selecciona el nombre del tutor.', 'error', messageElement);
                return;
            }

            if (photoTaken) {
                showMessage('Guardando evidencia, por favor espera...', 'info', messageElement, 0);

                try {
                    // Convertir la imagen capturada a un formato de datos base64
                    const imageDataURL = canvas.toDataURL('image/jpeg', 0.8);
                    const base64data = imageDataURL.split(',')[1];
                    
                    // Creamos un objeto FormData en lugar de un objeto JSON
                    const formData = new FormData();
                    formData.append('base64data', base64data);
                    formData.append('evidenceType', evidenceType);
                    formData.append('specificType', specificType);
                    formData.append('participantCode', participantCode);
                    formData.append('additionalInfo', additionalInfo);
                    formData.append('tutorName', tutorName);

                    const response = await fetch(scriptURL, {
                        method: 'POST',
                        body: formData, // Enviar el FormData en lugar del JSON
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.status === 'success') {
                            showMessage(`‚úÖ ¬°Evidencia guardada exitosamente!`, 'success', messageElement);
                            setTimeout(resetFormState, 2000);
                        } else {
                            showMessage(`‚ùå Error: ${result.message}`, 'error', messageElement);
                        }
                    } else {
                        showMessage('‚ùå Error en la conexi√≥n al servicio. Aseg√∫rate que el Apps Script est√© desplegado con acceso "Cualquiera".', 'error', messageElement);
                    }
                } catch (error) {
                    console.error('Error al guardar:', error);
                    showMessage('‚ùå Error al guardar: ' + error.message, 'error', messageElement);
                }
            } else {
                showMessage('‚ùå Por favor, captura una foto antes de guardar.', 'error', messageElement);
            }
        });

        downloadButton.addEventListener('click', async () => {
            const mainType = downloadMainTypeSelect.value;
            const specificType = downloadSpecificTypeSelect.value;
            const month = downloadMonthInput.value;
            
            if (!mainType || !specificType || !month) {
                showMessage('Por favor, selecciona un tipo, subtipo y mes para descargar.', 'error', downloadMessageElement);
                return;
            }

            showMessage('Generando archivo de descarga, por favor espera...', 'info', downloadMessageElement, 0);

            const params = new URLSearchParams({
                action: 'download',
                mainType: mainType,
                specificType: specificType,
                month: month,
            });

            const url = `${scriptURL}?${params.toString()}`;

            try {
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.status === 'success' && result.url) {
                    showMessage('‚úÖ Archivo listo. Descargando...', 'success', downloadMessageElement);
                    window.open(result.url, '_blank');
                    setTimeout(() => {
                        showMessage('¬°Descarga completada!', 'success', downloadMessageElement);
                    }, 5000);
                } else if (result.status === 'success' && !result.url) {
                    showMessage('‚ö†Ô∏è ' + result.message, 'info', downloadMessageElement);
                } else {
                    showMessage('‚ùå ' + result.message, 'error', downloadMessageElement);
                }
            } catch (error) {
                showMessage('‚ùå Error al procesar la descarga: ' + error.message, 'error', downloadMessageElement);
            }
        });

        // Funciones utilitarias
        function startCamera() {
            if (mediaStream) {
                stopCamera();
            }
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                .then(stream => {
                    mediaStream = stream;
                    cameraStreamElement.srcObject = stream;
                    cameraStreamElement.style.display = 'block';
                    cameraStreamElement.play();
                    captureButton.style.display = 'block';
                    stopCameraButton.style.display = 'block';
                    startCameraButton.classList.add('hidden');
                    canvas.style.display = 'none';
                    saveSection.style.display = 'none';
                    placeholderText.style.display = 'none';
                    photoTaken = false;
                    showMessage('C√°mara iniciada', 'info', messageElement);
                })
                .catch(error => {
                    showMessage('‚ùå No se puede acceder a la c√°mara. Revisa los permisos de tu navegador: ' + error.message, 'error', messageElement);
                    console.error('Error al acceder a la c√°mara:', error);
                });
        }

        function stopCamera() {
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                cameraStreamElement.srcObject = null;
                cameraStreamElement.style.display = 'none';
                captureButton.style.display = 'none';
                stopCameraButton.style.display = 'none';
                startCameraButton.classList.remove('hidden');
                saveSection.style.display = 'none';
                placeholderText.style.display = 'block';
            }
        }

        function capturePhoto() {
            if (!mediaStream) {
                showMessage('‚ùå Primero inicia la c√°mara.', 'error', messageElement);
                return;
            }
            
            const context = canvas.getContext('2d');
            const videoWidth = cameraStreamElement.videoWidth;
            const videoHeight = cameraStreamElement.videoHeight;
            
            canvas.width = videoWidth;
            canvas.height = videoHeight;
            
            context.drawImage(cameraStreamElement, 0, 0, videoWidth, videoHeight);
            
            photoTaken = true;
            cameraStreamElement.pause();
            cameraStreamElement.style.display = 'none';
            canvas.style.display = 'block';
            saveSection.style.display = 'flex';
            captureButton.style.display = 'none';
            stopCameraButton.style.display = 'none';
            showMessage('Foto capturada. Puedes guardarla o tomar otra.', 'success', messageElement);
        }

        function resetPhoto() {
            stopCamera();
            photoTaken = false;
            canvas.style.display = 'none';
            saveSection.style.display = 'none';
            messageElement.textContent = '';
            messageElement.className = 'message';
            startCameraButton.classList.remove('hidden');
        }

        function updateSpecificTypes() {
            const selectedType = evidenceTypeSelect.value;
            const specificTypes = EVIDENCE_OPTIONS[selectedType] || [];
            specificTypeSelect.innerHTML = '<option value="">-- Selecciona el tipo espec√≠fico --</option>';
            specificTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                specificTypeSelect.appendChild(option);
            });
        }

        function updateDownloadSpecificTypes() {
            const selectedType = downloadMainTypeSelect.value;
            const specificTypes = EVIDENCE_OPTIONS[selectedType] || [];
            downloadSpecificTypeSelect.innerHTML = '<option value="">-- Selecciona el tipo espec√≠fico --</option>';
            specificTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                downloadSpecificTypeSelect.appendChild(option);
            });
        }

        function toggleSections() {
            const selectedType = evidenceTypeSelect.value;
            
            participantsSection.classList.add('hidden');
            descriptionSection.classList.add('hidden');
            tutorSection.classList.add('hidden');
            
            if (selectedType) {
                if (selectedType === 'Seguimiento a participantes') {
                    participantsSection.classList.remove('hidden');
                    descriptionSection.classList.remove('hidden');
                    
                    // Actualizar la lista de participantes
                    participantCodeSelect.innerHTML = '<option value="">-- Selecciona un participante --</option>';
                    PARTICIPANTS_OPTIONS.forEach(p => {
                        const option = document.createElement('option');
                        option.value = p.code;
                        option.textContent = p.name;
                        participantCodeSelect.appendChild(option);
                    });

                } else if (selectedType === 'Operativas de gesti√≥n') {
                    tutorSection.classList.remove('hidden');
                    descriptionSection.classList.remove('hidden');
                    
                    // Actualizar la lista de tutores
                    tutorNameSelect.innerHTML = '<option value="">-- Selecciona un tutor --</option>';
                    TUTOR_OPTIONS.forEach(t => {
                        const option = document.createElement('option');
                        option.value = t;
                        option.textContent = t;
                        tutorNameSelect.appendChild(option);
                    });
                } else if (selectedType === 'Visitas Domiciliarias') {
                    descriptionSection.classList.remove('hidden');
                }
            }
        }

        // Funciones utilitarias
        function showMessage(msg, type, element, duration = 5000) {
            element.textContent = msg;
            element.className = `message show ${type}`;
            
            if (duration > 0) {
                setTimeout(() => {
                    element.classList.remove('show');
                    element.textContent = '';
                }, duration);
            }
        }

        function resetFormState() {
            evidenceTypeSelect.value = '';
            specificTypeSelect.innerHTML = '<option value="">-- Selecciona el tipo espec√≠fico --</option>';
            participantCodeSelect.innerHTML = '<option value="">-- Selecciona un participante --</option>';
            descriptionInput.value = '';
            tutorNameSelect.value = '';
            
            participantsSection.classList.add('hidden');
            descriptionSection.classList.add('hidden');
            tutorSection.classList.add('hidden');
            
            messageElement.classList.remove('show', 'success', 'error', 'info');
            messageElement.textContent = '';
            stopCamera();
            
            downloadMainTypeSelect.value = '';
            downloadSpecificTypeSelect.innerHTML = '<option value="">-- Primero selecciona el tipo principal --</option>';
            downloadMonthInput.value = '';
            downloadMessageElement.classList.remove('show', 'success', 'error', 'info');
            downloadMessageElement.textContent = '';
        }

    </script>
</body>
</html>
